<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Calendar</title>
<link rel="stylesheet" href="../examples/common.css">
<link rel="stylesheet" href="calendar.css">
<script src="../dev.js"></script>
<script src="../src/components/calendar.js"></script>
<style>
input { width: 100px; height: 20px; padding: 0 2px; border: 1px solid gainsboro; background: url(calendar.png) no-repeat right center; line-height: 20px; cursor: pointer; }
</style>
</head>
<body>
<h1>Calendar</h1>
<fieldset>
  <legend>月历</legend>
  <form id="test">
    <input id="from" type="text" value="" readonly data-type="date" data-min-date="2012-01-01" data-rel-id="to" data-rel-type="minDate"> ~ <input id="to" type="text" value="" readonly data-type="date" data-rel-id="from" data-rel-type="maxDate">
  </form>
</fieldset>
<script>
execute(function($) {
  /**
   * @name createDatePicker
   * @author sundongguo
   * @version 20080528
   *
   * 使用createDatePicker(sId)创建一个日历输入控件。
   * sId是目标元素。
   */
//--------------------------------------------------[calendar]
  var $from = $('#from');
  var $to = $('#to');

  // 日期选定。
  function format(n) {
    return n < 10 ? '0' + n : n;
  }

  function parseDate(dateString) {
    var ymd = dateString.split('-').map(function(item) {
      return Number.toInteger(item);
    });
    return new Date(ymd[0], ymd[1] - 1, ymd[2]);
  }

  calendar = null;
  var $calendar;
  var $pinnedElement;
  // 默认日期。
  var date;
  var minDate = '2012-03-01';
  date = new Date();
  date.setDate(date.getDate() - 1);
  var maxDate = date.getFullYear() + '-' + format(date.getMonth() + 1) + '-' + format(date.getDate());
  $from.setData('minDate', minDate);
  $from.setData('maxDate', maxDate);
  $to.setData('minDate', minDate);
  $to.setData('maxDate', maxDate);
  $to.value = maxDate;
  date = parseDate($to.value);
  date.setDate(date.getDate() - 6);
  $from.value = date.getFullYear() + '-' + format(date.getMonth() + 1) + '-' + format(date.getDate());
//    $from.value = '2012-03-01';
//    $to.value = '2012-03-30';
  // 选择事件。
  document.on('click', function(e) {
    var $target = e.target;
    if ($target != $pinnedElement && $target.nodeName === 'INPUT' && $target.type === 'text') {
      var type = $target.getData('type');
      if (type === 'date') {
        if (!calendar) {
          var calendar = new Calendar({minDate: minDate, maxDate: maxDate})
              .on('select',
              function(e) {
                $pinnedElement.value = e.date;
                $pinnedElement.highlight({color: '#FFD700'});
                var date;
                var showDate;
                var $rel = $('#' + $pinnedElement.getData('relId'));
                if ($rel) {
                  var relType = $rel.getData('relType');
                  if (relType === 'maxDate') {
                    // 判断最大时间是否在范围内，若不在则修改。
                    date = parseDate($rel.value);
                    var selectedMaxDate = parseDate(e.date);
                    selectedMaxDate.setDate(selectedMaxDate.getDate() + 29);
                    showDate = new Date(Math.limit(date.getTime(), parseDate(e.date).getTime(), selectedMaxDate.getTime()));
                    if (date.getTime() !== showDate.getTime()) {
                      $rel.highlight({color: '#FFD700'});
                      $rel.value = showDate.getFullYear() + '-' + format(showDate.getMonth() + 1) + '-' + format(showDate.getDate());
                    }
                  } else {
                    // 判断最小时间是否在范围内，若不在则修改。
                    date = parseDate($rel.value);
                    var selectedMinDate = parseDate(e.date);
                    selectedMinDate.setDate(selectedMinDate.getDate() - 29);
                    showDate = new Date(Math.limit(date.getTime(), selectedMinDate.getTime(), parseDate(e.date).getTime()));
                    if (date.getTime() !== showDate.getTime()) {
                      $rel.highlight({color: '#FFD700'});
                      $rel.value = showDate.getFullYear() + '-' + format(showDate.getMonth() + 1) + '-' + format(showDate.getDate());
                    }
                  }
                }
                calendar.fire('hide');
              })
              .on('hide',
              function(e) {
                this.getElement().setStyle('display', 'none');
                $pinnedElement = null;
              });
          $calendar = calendar.getElement();
        }
        $pinnedElement = $target;
        if ($target.value) {
          calendar.date = $target.value;
        }
        calendar.render($pinnedElement.value);
        $calendar.putAfter($target).setStyle('display', 'block');
        var targetPosition = $pinnedElement.getClientRect();
        var calendarPosition = $calendar.getClientRect();
        var offsetX = calendarPosition.left - targetPosition.left;
        var offsetY = calendarPosition.top - targetPosition.bottom;
        $calendar.setStyles({left: $calendar.offsetLeft - offsetX, top: $calendar.offsetTop - offsetY});
      }
      return false;
    } else {
      if (calendar) {
        calendar.fire('hide');
      }
    }
  });
});
</script>
</body>
</html>
