<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Calendar</title>
<link rel="stylesheet" href="../examples/common.css">
<link rel="stylesheet" href="calendar.css">
<script src="../dev.js"></script>
<script src="../src/components/calendar.js"></script>
</head>
<body>
<h1>Calendar</h1>
<!-- 月历 -->
<style>
#container { padding: 10px; }
</style>
<fieldset>
  <legend>月历（基本形式）</legend>
  <div id="container"></div>
</fieldset>
<script>
execute(function($) {
  var calendar = new Calendar({minDate: '2011-10-15', maxDate: '2012-06-30', firstDayOfWeek: 0})
      .on('render', function(e) {
        console.log(e.type, e.renderedMonth);
      });
  $('#container').append(calendar.getElement());
  calendar.render();
});
</script>

<!-- 日期选择器 -->
<style>
#date_picker input { width: 100px; height: 20px; padding: 0 2px; border: 1px solid gainsboro; background: url(calendar.png) no-repeat right center; line-height: 20px; cursor: pointer; }
#date_picker .calendar { position: absolute; }
#date_picker .calendar td.prev_month.enabled:hover,
#date_picker .calendar td.next_month.enabled:hover { background: transparent; border-color: yellowgreen; }
#date_picker .calendar td.enabled:hover { background: greenyellow; border-color: yellowgreen; }
#date_picker .calendar td.prev_month.selected,
#date_picker .calendar td.next_month.selected,
#date_picker .calendar td.prev_month.selected:hover,
#date_picker .calendar td.next_month.selected:hover { background: transparent; border-color: maroon; }
#date_picker .calendar td.selected,
#date_picker .calendar td.selected:hover { background: #FF7B3A; border-color: maroon; font-weight: bold; text-decoration: underline; }
#date_picker .calendar td.today { font-weight: normal; text-decoration: none; }
#date_picker .calendar span.clear { left: 1px; width: 61px; }
#date_picker .calendar span.today { right: 1px; width: 61px; }
</style>
<fieldset>
  <legend>日期选择器</legend>
  <form id="date_picker">
    <input type="text" value="" readonly data-type="date" data-min-date="2000-01-01" data-max-date="2099-12-31"> 2000-01-01~2099-12-31<br>
    <input type="text" value="" readonly data-type="date" data-min-date="2012-01-01" data-max-date="2012-05-31"> 2012-01-01~2012-05-31
  </form>
</fieldset>
<script>
execute(function($) {
//==================================================[<Date Picker>]
  /*
   * 表单增强-日期选择器。
   */

//--------------------------------------------------[enableDatePicker]
  /**
   * 表单增强-日期选择器。
   */
  function enableDatePicker() {
    // 依赖 Calendar 组件。
    if (!Calendar) {
      return;
    }
    // 启用 Date Picker 支持。
    var datePicker;
    var $datePicker;
    var $pinnedElement;
    document.on('click', function(e) {
      var $target = e.target;
      // 先关闭当前的日期选择器。
      if (datePicker && datePicker.isShown) {
        datePicker.hide();
      }
      // 启用的首要条件为点击到了 INPUT[type=text] 元素，但不是当前的 $pinnedElement。
      if ($target !== $pinnedElement && $target.nodeName === 'INPUT' && $target.type === 'text') {
        // 日期选择器有“普通”和“组合”两种类型。
        $pinnedElement = $target;
        console.log($pinnedElement);
        var type = $target.getData('type');
        if (type === 'date') {
          // 普通日期选择器。
          if (!datePicker) {
            datePicker = new Calendar()
                .on('cellUpdate', function(e) {
                  var $cell = e.cell;
                  var date = e.date;
                  $cell.title = date.format();
                  if ($cell.hasClass('disabled')) {
                    $cell.title += '(超出范围)';
                  }
                  if (this.selectedDate && this.selectedDate.getTime() === date.getTime()) {
                    $cell.addClass('selected');
                  }
                });
            $datePicker = datePicker.getElement();
            datePicker.isShown = false;
            datePicker.show = function() {
              if (!this.isShown) {
                $datePicker.putAfter($pinnedElement).setStyle('display', 'block');
                var targetPosition = $pinnedElement.getClientRect();
                var calendarPosition = $datePicker.getClientRect();
                var offsetX = calendarPosition.left - targetPosition.left;
                var offsetY = calendarPosition.top - targetPosition.bottom;
                $datePicker.setStyles({left: $datePicker.offsetLeft - offsetX, top: $datePicker.offsetTop - offsetY});
                this.isShown = true;
                this.fire('show');
              }
              return this;
            };
            datePicker.hide = function() {
              if (this.isShown) {
                this.getElement().remove(true);
                $pinnedElement = null;
                this.isShown = false;
                this.fire('close');
              }
              return this;
            };
            datePicker.setValue = function(value) {
              if ($pinnedElement.value !== value) {
                $pinnedElement.highlight('gold', 1, {duration: 300}).value = value;
              }
              return this;
            };
            datePicker.clearValue = function() {
              if ($pinnedElement.value !== '') {
                $pinnedElement.highlight('orangered', 1, {duration: 300}).value = '';
              }
              return this;
            };
            // 阻止 $datePicker 内的 click 事件向外传播。
            $datePicker.on('click', function(e) {
              return false;
            });
            // 绑定选择事件。
            $datePicker.on('click:relay(.enabled)', function(e) {
              datePicker.setValue(this.title);
              datePicker.hide();
              return false;
            });
            // 添加“清除”和“今天”按钮。
            var $clear = $('<span class="btn clear">清除</span>').on('click', function(e) {
              datePicker.clearValue().hide();
            });
            var today;
            var $today = $('<span class="btn today">今天</span>').on('click', function(e) {
              datePicker.setValue(today.format()).hide();
            });
            // 确定“清除”和“今天”按钮是否可用。
            datePicker.on('show', function(e) {
              console.log($pinnedElement.value);
              if ($pinnedElement.value === '') {
                $clear.addClass('disabled').title = '(还没有选定值)';
              } else {
                $clear.removeClass('disabled')
              }
              today = Date.from(new Date().format());
              if (today < Date.from($pinnedElement.getData('minDate')) || today > Date.from($pinnedElement.getData('maxDate'))) {
                $today.addClass('disabled').title = '(超出范围)';
              } else {
                $today.removeClass('disabled')
              }
            });
            var $additionalControls = $('<div></div>').append($clear).append($today);
            $datePicker.append($additionalControls);
          }
          datePicker.setOptions({minDate: $pinnedElement.getData('minDate'), maxDate: $pinnedElement.getData('maxDate')});
          datePicker.selectedDate = $pinnedElement.value ? Date.from($pinnedElement.value) : null;
          datePicker.render($pinnedElement.value ? $pinnedElement.value.slice(0, 7) : undefined).show();
          // 显示月历。
        }
      }
    });
  }

  enableDatePicker();

});
</script>
</body>
</html>
